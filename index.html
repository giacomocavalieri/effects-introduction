<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.101.0"><meta charset=utf-8><title>Effects</title><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=/effects-introduction/reveal-js/css/reset.css><link rel=stylesheet href=/effects-introduction/reveal-js/css/reveal.css><link rel=stylesheet href=/effects-introduction/custom.css id=theme><link rel=stylesheet href=/effects-introduction/highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section><h1 id=modellazione-degli-effetti>Modellazione degli Effetti</h1></section><section><h2 id=effects>Effects</h2><p>The essence of programming ultimately boils down to performing effects. As Simon Peyton Jones puts it:</p><blockquote><p>If a program has no side-effects there&rsquo;s no point in running it, isn&rsquo;t it? You have a black box, you press go and it gets hot but there&rsquo;s no output <a href=#resources>^1</a></p></blockquote></section><section><h2 id=a-simple-running-example>A simple running example</h2><p>Being undoubtedly very convenient, many languages allow the programmer to use <em>statements</em> as a way to perform unrestricted side-effects: I/O, failure, non-determinism, &mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=k>def</span> <span class=n>maybeDouble</span><span class=o>(</span><span class=n>n</span><span class=k>:</span> <span class=kt>Int</span><span class=o>)</span><span class=k>:</span> <span class=kt>Int</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=n>println</span><span class=o>(</span><span class=s>&#34;Flipping a coin&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=n>heads</span> <span class=k>=</span> <span class=n>util</span><span class=o>.</span><span class=nc>Random</span><span class=o>.</span><span class=n>nextBoolean</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=n>heads</span> <span class=n>then</span> <span class=n>n</span><span class=o>*</span><span class=mi>2</span> <span class=k>else</span> <span class=n>n</span>
</span></span></code></pre></div></section><section><p>The problem with unrestricted side-effects is that there no longer is <em>referential transparency:</em> while one can factor out duplicate values the same is not true for statements, they are not easily testable and it is overall harder to reason about the program&rsquo;s behavior</p><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=k>val</span> <span class=n>program1</span><span class=k>:</span> <span class=kt>Int</span> <span class=o>=</span> <span class=n>maybeDouble</span><span class=o>(</span><span class=mi>1</span><span class=o>)</span> <span class=o>+</span> <span class=n>maybeDouble</span><span class=o>(</span><span class=mi>1</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>program2</span><span class=k>:</span> <span class=kt>Int</span> <span class=o>=</span> <span class=o>{</span>Â <span class=k>val</span> <span class=n>n</span> <span class=k>=</span> <span class=n>maybeDouble</span><span class=o>(</span><span class=mi>1</span><span class=o>);</span> <span class=n>n</span> <span class=o>+</span> <span class=n>n</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1>// the two programs are not equivalent since maybeDouble
</span></span></span><span class=line><span class=cl><span class=c1>// performs side effects
</span></span></span></code></pre></div></section><section><h2 id=monads-to-the-rescue>Monads to the rescue</h2><p>In a purely functional world the key difference is that a program no longer performs the side effects but it is an immutable data structure that <em>describes</em> what side effects need to be performed:</p><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=k>def</span> <span class=n>maybeDouble</span><span class=o>(</span><span class=n>n</span><span class=k>:</span> <span class=kt>Int</span><span class=o>)</span><span class=k>:</span> <span class=kt>IO</span><span class=o>[</span><span class=kt>Int</span><span class=o>]</span> <span class=k>=</span> <span class=k>for</span>
</span></span><span class=line><span class=cl>  <span class=k>_</span>     <span class=k>&lt;-</span> <span class=nc>IO</span><span class=o>.</span><span class=n>println</span><span class=o>(</span><span class=s>&#34;Flipping a coin&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=n>heads</span> <span class=k>&lt;-</span> <span class=nc>IO</span><span class=o>(</span><span class=n>util</span><span class=o>.</span><span class=nc>Random</span><span class=o>.</span><span class=n>nextBoolean</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>yield</span> <span class=o>(</span><span class=k>if</span> <span class=n>heads</span> <span class=n>then</span> <span class=n>n</span><span class=o>*</span><span class=mi>2</span> <span class=k>else</span> <span class=n>n</span><span class=o>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=nf>maybeDouble</span> <span class=ow>::</span> <span class=kt>Int</span> <span class=ow>-&gt;</span> <span class=kt>IO</span> <span class=kt>Int</span>
</span></span><span class=line><span class=cl><span class=nf>maybeDouble</span> <span class=n>n</span> <span class=ow>=</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>  <span class=n>putStrLn</span> <span class=s>&#34;Flipping a coin&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>heads</span> <span class=ow>&lt;-</span> <span class=n>randomIO</span>
</span></span><span class=line><span class=cl>  <span class=n>pure</span> <span class=o>$</span> <span class=kr>if</span> <span class=n>heads</span> <span class=kr>then</span> <span class=n>n</span><span class=o>*</span><span class=mi>2</span> <span class=kr>else</span> <span class=n>n</span>
</span></span></code></pre></div></section><section><p>Thanks to the <code>IO</code> monad one can treat <em>programs as first-class values:</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=k>val</span> <span class=n>p</span> <span class=k>=</span> <span class=n>maybeDouble</span><span class=o>(</span><span class=mi>10</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>ns</span><span class=k>:</span> <span class=kt>IO</span><span class=o>[</span><span class=kt>List</span><span class=o>[</span><span class=kt>Int</span><span class=o>]]</span> <span class=k>=</span> <span class=nc>List</span><span class=o>.</span><span class=n>fill</span><span class=o>(</span><span class=mi>5</span><span class=o>)(</span><span class=n>p</span><span class=o>).</span><span class=n>sequence</span>
</span></span></code></pre></div><p><code>p</code> is not an integer value that could be either 10 or 20; it is an immutable data structure that describes the logic with which 10 may or may not be doubled by performing side-effects</p></section><section><p>Monads can capture the idea of sequencing a wide range of side effects:</p><ul><li><code>State</code> mutable global state</li><li><code>Maybe</code> possible failure with short-circuiting</li><li><code>Reader</code> global immutable state</li><li><code>List</code> non-determinism</li><li><code>Future, Writer, Parser, ...</code></li></ul></section><section><h2 id=dealing-with-multiple-side-effects>Dealing with multiple side-effects</h2><p>However our code usually needs more than a single side-effect, luckily, thanks to <em>monad transformers</em> monads can be <em>stacked</em> together to obtain composite monads</p><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=k>final</span> <span class=k>case</span> <span class=k>class</span> <span class=nc>MaybeT</span><span class=o>[</span><span class=kt>M</span><span class=o>[</span><span class=k>_</span><span class=o>]</span>, <span class=kt>A</span><span class=o>](</span><span class=n>runMaybeT</span> <span class=k>:</span> <span class=kt>M</span><span class=o>[</span><span class=kt>Maybe</span><span class=o>[</span><span class=kt>A</span><span class=o>]])</span>
</span></span><span class=line><span class=cl><span class=k>final</span> <span class=k>case</span> <span class=k>class</span> <span class=nc>StateT</span><span class=o>[</span><span class=kt>S</span>, <span class=kt>M</span><span class=o>[</span><span class=k>_</span><span class=o>]</span>, <span class=kt>A</span><span class=o>](</span><span class=n>runStateT</span> <span class=k>:</span> <span class=kt>S</span> <span class=o>=&gt;</span> <span class=n>M</span><span class=o>[(</span><span class=kt>A</span>, <span class=kt>S</span><span class=o>)])</span>
</span></span><span class=line><span class=cl><span class=k>final</span> <span class=k>case</span> <span class=k>class</span> <span class=nc>ReaderT</span><span class=o>[</span><span class=kt>S</span>, <span class=kt>M</span><span class=o>[</span><span class=k>_</span><span class=o>]</span>, <span class=kt>A</span><span class=o>](</span><span class=n>runReaderT</span> <span class=k>:</span> <span class=kt>S</span> <span class=o>=&gt;</span> <span class=n>M</span><span class=o>[</span><span class=kt>A</span><span class=o>])</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=kr>newtype</span> <span class=kt>MaybeT</span>    <span class=n>m</span> <span class=n>a</span> <span class=ow>=</span> <span class=kt>MaybeT</span>  <span class=p>{</span> <span class=n>runMaybeT</span>  <span class=ow>::</span> <span class=n>m</span> <span class=p>(</span><span class=kt>Maybe</span> <span class=n>a</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>newtype</span> <span class=kt>StateT</span>  <span class=n>s</span> <span class=n>m</span> <span class=n>a</span> <span class=ow>=</span> <span class=kt>StateT</span>  <span class=p>{</span> <span class=n>runStateT</span>  <span class=ow>::</span> <span class=n>s</span> <span class=ow>-&gt;</span> <span class=n>m</span> <span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>newtype</span> <span class=kt>ReaderT</span> <span class=n>s</span> <span class=n>m</span> <span class=n>a</span> <span class=ow>=</span> <span class=kt>ReaderT</span> <span class=p>{</span> <span class=n>runReaderT</span> <span class=ow>::</span> <span class=n>s</span> <span class=ow>-&gt;</span> <span class=n>m</span> <span class=n>a</span> <span class=p>}</span>
</span></span></code></pre></div></section><section><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=c1>// With the compiler plugin -Ykind-projector:underscores enabled
</span></span></span><span class=line><span class=cl><span class=c1>// one can define a type lambda with the same syntax used for 
</span></span></span><span class=line><span class=cl><span class=c1>// a term lambda
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>def</span> <span class=n>program</span><span class=k>:</span> <span class=kt>MaybeT</span><span class=o>[</span><span class=kt>ReaderT</span><span class=o>[</span><span class=kt>String</span>, <span class=kt>IO</span>, <span class=k>_</span><span class=o>]</span>, <span class=kt>Int</span><span class=o>]</span> <span class=k>=</span> <span class=o>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=nf>program</span> <span class=ow>::</span> <span class=kt>MaybeT</span> <span class=p>(</span><span class=kt>ReaderT</span> <span class=kt>String</span> <span class=kt>IO</span><span class=p>)</span> <span class=kt>Int</span>
</span></span><span class=line><span class=cl><span class=nf>program</span> <span class=ow>=</span> <span class=o>...</span>
</span></span></code></pre></div><p><code>program</code> can perform 3 kinds of side-effects:</p><ul><li>it can fail (<code>MaybeT</code>)</li><li>it can read a global configuration of type <code>String</code> (<code>ReaderT</code>)</li><li>it can perform I/O (<code>IO</code>)</li></ul></section><section><p>There still are problems: the code inside <code>IO</code> is just as hard to test as the impure counterpart; the only way to get a result out of <code>IO</code> is to interpret the data structure ultimately performing the side effects</p><p>((TODO Esempio di codice))
((TODO trovare articolo in cui si parla di come esplicitare la monade in questo modo rompe incapsulamente, program against an interface))</p></section><section><h2 id=mtl--tagless-final>MTL / Tagless Final</h2><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=k>def</span> <span class=n>maybeDouble</span><span class=o>[</span><span class=kt>M</span><span class=o>[</span><span class=k>_</span><span class=o>]</span><span class=kt>:</span> <span class=kt>Monad:</span> <span class=kt>CoinFlip:</span> <span class=kt>Console</span><span class=o>](</span><span class=n>n</span><span class=k>:</span> <span class=kt>Int</span><span class=o>)</span><span class=k>:</span> <span class=kt>M</span><span class=o>[</span><span class=kt>Int</span><span class=o>]</span> <span class=k>=</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> 
</span></span><span class=line><span class=cl>    <span class=k>_</span>     <span class=k>&lt;-</span> <span class=nc>Console</span><span class=o>[</span><span class=kt>M</span><span class=o>].</span><span class=n>println</span><span class=o>(</span><span class=s>&#34;Flipping a coin&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>heads</span> <span class=k>&lt;-</span> <span class=nc>CoinFlip</span><span class=o>[</span><span class=kt>M</span><span class=o>].</span><span class=n>flipCoin</span>
</span></span><span class=line><span class=cl>  <span class=k>yield</span> <span class=o>(</span><span class=k>if</span> <span class=n>heads</span> <span class=n>then</span> <span class=n>n</span><span class=o>*</span><span class=mi>2</span> <span class=k>else</span> <span class=n>n</span><span class=o>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=nf>maybeDouble</span> <span class=ow>::</span> <span class=p>(</span><span class=kt>Monad</span> <span class=n>m</span><span class=p>,</span> <span class=kt>CoinFlip</span> <span class=n>m</span><span class=p>,</span> <span class=kt>Console</span> <span class=n>m</span><span class=p>)</span> <span class=ow>=&gt;</span> <span class=kt>Int</span> <span class=ow>-&gt;</span> <span class=n>m</span> <span class=kt>Int</span>
</span></span><span class=line><span class=cl><span class=nf>maybeDouble</span> <span class=n>n</span> <span class=ow>=</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>  <span class=n>println</span> <span class=s>&#34;Flipping a coin&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>heads</span> <span class=ow>&lt;-</span> <span class=n>flipCoin</span>
</span></span><span class=line><span class=cl>  <span class=n>pure</span> <span class=o>$</span> <span class=kr>if</span> <span class=n>heads</span> <span class=kr>then</span> <span class=n>n</span><span class=o>*</span><span class=mi>2</span> <span class=kr>else</span> <span class=n>n</span>
</span></span></code></pre></div></section><section><h2 id=free-monads>Free monads</h2><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=k>def</span> <span class=n>maybeDouble</span><span class=o>(</span><span class=n>n</span><span class=k>:</span> <span class=kt>Int</span><span class=o>)</span><span class=k>:</span> <span class=kt>App</span><span class=o>[</span><span class=kt>Int</span><span class=o>]</span> <span class=k>=</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span>
</span></span><span class=line><span class=cl>    <span class=k>_</span>     <span class=k>&lt;-</span> <span class=n>print</span><span class=o>(</span><span class=s>&#34;Flipping a coin&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>heads</span> <span class=k>&lt;-</span> <span class=n>flipCoin</span>
</span></span><span class=line><span class=cl>  <span class=k>yield</span> <span class=o>(</span><span class=k>if</span> <span class=n>heads</span> <span class=n>then</span> <span class=n>n</span><span class=o>*</span><span class=mi>2</span> <span class=k>else</span> <span class=n>n</span><span class=o>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=nf>maybeDouble</span> <span class=ow>::</span> <span class=kt>Int</span> <span class=ow>-&gt;</span> <span class=kt>App</span> <span class=kt>Int</span>
</span></span><span class=line><span class=cl><span class=nf>maybeDouble</span> <span class=n>n</span> <span class=ow>=</span> <span class=kr>do</span>
</span></span><span class=line><span class=cl>  <span class=n>println</span> <span class=s>&#34;Flipping a coin&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>heads</span> <span class=ow>&lt;-</span> <span class=n>flipCoin</span>
</span></span><span class=line><span class=cl>  <span class=n>pure</span> <span class=o>$</span> <span class=kr>if</span> <span class=n>heads</span> <span class=kr>then</span> <span class=n>n</span><span class=o>*</span><span class=mi>2</span> <span class=kr>else</span> <span class=n>n</span>
</span></span></code></pre></div></section><section><h2 id=unison>Unison</h2><div class=highlight><pre tabindex=0 class=chroma><code class=nohighlight data-noescape><span class=line><span class=cl><span class=nf>maybeDouble</span> <span class=kt>:</span> <span class=kt>Int</span> <span class=ow>-&gt;</span> <span class=p>{</span><span class=kt>CoinFlip</span><span class=p>,</span> <span class=kt>Console</span><span class=p>}</span> <span class=kt>Int</span>
</span></span><span class=line><span class=cl><span class=nf>maybeDouble</span> <span class=n>n</span> <span class=ow>=</span>
</span></span><span class=line><span class=cl>  <span class=n>println</span> <span class=s>&#34;Flipping a coin&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>heads</span> <span class=ow>=</span> <span class=n>flipCoin</span>
</span></span><span class=line><span class=cl>  <span class=kr>if</span> <span class=n>heads</span> <span class=kr>then</span> <span class=n>n</span><span class=o>*</span><span class=mi>2</span> <span class=kr>else</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>  <span class=c1>-- One can use a direct style, no monadic binding!</span>
</span></span><span class=line><span class=cl>  <span class=c1>-- if flipCoin then n*2 else n</span>
</span></span></code></pre></div></section><section><h2 id=resources>Resources</h2><ol><li><a href="https://www.youtube.com/watch?v=iSmkqocn0oQ">Simon Peyton Jones - Haskell is Useless</a> ^1</li></ol></section></div></div><script type=text/javascript src=/effects-introduction/reveal-hugo/object-assign.js></script>
<a href=/effects-introduction/reveal-js/css/print/ id=print-location style=display:none></a>
<script type=text/javascript>var printLocationElement=document.getElementById("print-location"),link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?"pdf.css":"paper.css"),document.getElementsByTagName("head")[0].appendChild(link)</script><script type=application/json id=reveal-hugo-site-params>{"custom_theme":"custom.css","slide_number":true}</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=/effects-introduction/reveal-js/js/reveal.js></script>
<script type=text/javascript>function camelize(e){return e&&Object.keys(e).forEach(function(t){newK=t.replace(/(_\w)/g,function(e){return e[1].toUpperCase()}),newK!=t&&(e[newK]=e[t],delete e[t])}),e}var revealHugoDefaults={center:!0,controls:!0,history:!0,progress:!0,transition:"slide"},revealHugoSiteParams=JSON.parse(document.getElementById("reveal-hugo-site-params").innerHTML),revealHugoPageParams=JSON.parse(document.getElementById("reveal-hugo-page-params").innerHTML),options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options)</script><script type=text/javascript src=/effects-introduction/reveal-js/plugin/markdown/marked.js></script>
<script type=text/javascript src=/effects-introduction/reveal-js/plugin/markdown/markdown.js></script>
<script type=text/javascript src=/effects-introduction/reveal-js/plugin/highlight/highlight.js></script>
<script type=text/javascript src=/effects-introduction/reveal-js/plugin/zoom-js/zoom.js></script>
<script type=text/javascript src=/effects-introduction/reveal-js/plugin/notes/notes.js></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script>
<script>mermaid.initialize({startOnLoad:!1});let render=e=>{let t=e.currentSlide.querySelectorAll(".mermaid");if(!t.length)return;t.forEach(e=>{let t=e.getAttribute("data-processed");t||mermaid.init(void 0,e)})};Reveal.addEventListener("slidechanged",render),Reveal.addEventListener("ready",render)</script></body></html>